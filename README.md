# コントラスト (Contrast) - AIボードゲーム

5x5の盤面で、タイルの色によって移動方向が変化する戦略的な2人対戦ボードゲームです。

## ゲームルール

### 基本情報
- **盤面**: 5x5グリッド
- **プレイヤー**: 2人
- **各プレイヤーのコマ**: 5個
- **持ちタイル**: 黒タイル3枚、グレータイル1枚
- **ターン制**: 交互に1手ずつ行動、駒を動かした後にタイルを配置可能
- **移動制限**: 相手のコマがいるマスには移動不可、自分の駒が隣にある場合、その駒を飛び越えて移動可能
- **タイル制限**: タイルの再配置は認められない
- **勝利条件**: 相手の陣地（後列）に最初に到達
- **敗北条件**: 自分の駒が全て動けなくなった場合

### タイルシステム
- **白タイル** (□): 縦横方向に1マス移動可能
- **黒タイル** (■): 斜め方向に1マス移動可能
- **グレータイル** (▦): 全8方向に1マス移動可能

### 初期配置
```
   0  1  2  3  4
0 [2][2][2][2][2]  ← Player 2 (ゴールはy=4)
1 [ ][ ][ ][ ][ ]
2 [ ][ ][ ][ ][ ]
3 [ ][ ][ ][ ][ ]
4 [1][1][1][1][1]  ← Player 1 (ゴールはy=0)
```

### ゲームの流れ
1. 各ターン、プレイヤーは以下を実行:
   - (オプション) 白タイルを黒/グレータイルに変更
   - 自分のコマを1つ移動
2. **相手のコマがいるマスには移動できません**
3. タイル配置数: 黒タイル×3、グレータイル×1 (各プレイヤー)

## 使い方

### 1. 学習済みモデルと対戦
```bash
# デフォルト設定で対戦 (プレイヤー1として、100シミュレーション)
uv run play_vs_ai.py

# オプション指定
uv run play_vs_ai.py --model contrast_model_final.pth --simulations 200 --player 1

# ヘルプ表示
uv run play_vs_ai.py --help
```

#### 操作方法
- **駒の移動**: 移動元の座標と移動先の座標を入力 (例: `2,4` → `2,3`)
- **タイル配置**: 移動後にタイルを配置するか選択
  - 0: タイルなし
  - 1: 黒タイル (斜め移動)
  - 2: グレータイル (全方向移動)
- **盤面記号**:
  - `[1□]`: プレイヤー1の駒 (白タイル上)
  - `[2■]`: プレイヤー2の駒 (黒タイル上)
  - ` ▦ `: グレータイル

### 2. AIを学習させる
```bash
# 学習実行 (main.pyで設定を調整)
uv run main.py

# デバッグモード
uv run debug.py
```

## セットアップ

### 必要要件
- Python 3.8+
- PyTorch 2.0+
- NumPy

### インストール (uv使用)
```bash
# uvで依存関係をインストール
uv sync
```

### 3. テストを実行
```bash
# 全テストを実行
uv run -m pytest tests -v

# ContrastGameのテストのみ
uv run -m pytest tests/test_contrast_game.py -v

# MCTSのテストのみ
uv run -m pytest tests/test_mcts.py -v
```

## テスト

### テストカバレッジ

プロジェクトには **86個** の網羅的なテストが含まれています。

#### ContrastGame テスト (47テスト)

**1. 初期化と初期配置 (5テスト)**
- 初期盤面の配置確認
- 初期タイル（全て白）の確認
- 持ちタイル数（黒3、グレー1）の確認
- 最初のプレイヤーの確認
- ゲーム開始状態の確認

**2. 移動ルール (8テスト)**
- 白タイル：縦横移動のテスト
- 黒タイル：斜め移動のテスト
- グレータイル：8方向移動のテスト
- 相手の駒によるブロックのテスト
- 味方の駒を飛び越える動作のテスト
- 盤外への移動不可のテスト
- 相手の駒を動かせないことのテスト
- 複数の味方駒の連続飛び越えのテスト

**3. タイル配置ルール (5テスト)**
- 黒タイル配置の動作確認
- グレータイル配置の動作確認
- 移動先への配置不可の確認
- 既存コマ位置への配置不可の確認
- タイル使い切り後の動作確認

**4. 勝利条件 (3テスト)**
- P1が上段到達で勝利することの確認
- P2が下段到達で勝利することの確認
- 勝者なしでゲーム継続の確認

**4.5. 敗北条件 (2テスト)** ⭐新規追加
- 合法手がない場合に敗北することの確認
- 相手の行動後に合法手がなくなり敗北することの確認

**5. アクションエンコーディング (4テスト)**
- アクションのエンコード基本動作
- アクションのデコード基本動作
- エンコード↔デコードの往復変換
- ハッシュ値の範囲確認

**6. 合法手生成 (4テスト)**
- 初期状態での合法手存在確認
- ゲーム終了時の合法手なし確認
- タイルなし移動の含有確認
- 全合法手の実行可能性確認

**7. ゲームコピー (2テスト)**
- 独立したインスタンス作成の確認
- 状態の正確な保存の確認

**8. 状態エンコーディング (4テスト)**
- テンソル形状 (90, 5, 5) の確認
- データ型 (float32) の確認
- 履歴パディングの確認
- 値の範囲の確認

**9. 履歴管理 (3テスト)**
- 履歴の初期化確認
- ステップごとの更新確認
- 最大長8の維持確認

**10. エッジケース (3テスト)**
- 全駒ブロック状態の処理（合法手が0になることを確認）
- ゲームリセット機能
- プレイヤー切り替えマッピング

**11. 複雑なシナリオ (4テスト)**
- 完全なゲームシミュレーション
- プレイヤー交互切り替えの確認
- タイル配置による移動変化の確認
- アクション一貫性の確認

#### MCTS テスト (39テスト)

**1. MCTS初期化 (3テスト)**
- 基本的な初期化の確認
- カスタムパラメータでの初期化
- 空の辞書状態の確認

**2. ゲーム状態キー生成 (4テスト)**
- 決定的なキー生成の確認
- 異なる状態で異なるキー生成の確認
- move_countの含有確認
- プレイヤー情報の含有確認

**3. ノード展開 (6テスト)**
- エントリ作成の確認
- 値の初期化確認
- 評価値の返却確認
- 合法手のみ展開の確認
- 確率の合計が1であることの確認
- 終了状態の展開確認

**4. 探索 (5テスト)**
- ポリシー返却の確認
- 確率合計が1であることの確認
- 複数シミュレーションの実行確認
- ディリクレノイズ付加の確認
- 終了状態で空返却の確認

**5. 評価 (5テスト)**
- 終了状態（勝者）の評価値確認
- 終了状態（敗者）の評価値確認
- 終了状態（引き分け）の評価値確認
- 未展開ノードの展開確認
- 統計の更新確認

**6. PUCT (2テスト)**
- 未訪問アクション優先の確認
- 探索と活用のバランス確認

**7. バックプロパゲーション (2テスト)**
- 訪問回数の更新確認
- 価値の更新確認

**8. エッジケース (5テスト)**
- シミュレーション回数0の処理
- シミュレーション回数1の処理
- 合法手なし状態の処理
- 同一ツリーでの複数探索
- 元のゲーム状態の非変更確認

**9. 実際のネットワークとの統合 (2テスト)**
- 実ネットワークでの動作確認
- ポリシーの合法性確認

**10. 統合テスト (3テスト)**
- 完全なゲームシミュレーション
- シミュレーション回数による改善確認
- ゲーム状態遷移の処理確認

**11. 価値の伝播 (2テスト)**
- 再帰中の価値反転確認
- 終了価値の伝播確認

### テスト実行結果

```bash
$ uv run -m pytest test_contrast_game.py test_mcts.py -v
============================== 84 passed in 1.30s ==============================
```

全84テストが成功し、ゲームロジックとMCTSアルゴリズムの正確性が保証されています。
